"use strict";
// Copyright 2021 Amazon.com, Inc. or its affiliates. All Rights Reserved.
// SPDX-License-Identifier: MIT-0
Object.defineProperty(exports, "__esModule", { value: true });
exports.RecordingAPIStack = void 0;
const cdk = require("@aws-cdk/core");
const nodeLambda = require("@aws-cdk/aws-lambda-nodejs");
const lambda = require("@aws-cdk/aws-lambda");
const apigw = require("@aws-cdk/aws-apigateway");
const apigw2 = require("@aws-cdk/aws-apigatewayv2");
const apigw2i = require("@aws-cdk/aws-apigatewayv2-integrations");
const iam = require("@aws-cdk/aws-iam");
class RecordingAPIStack extends cdk.NestedStack {
    constructor(scope, id, props) {
        var _a, _b, _c, _d, _e, _f, _g;
        super(scope, id, props);
        //create startRecording Lambda
        const startRecordingLambda = new nodeLambda.NodejsFunction(this, 'StartRecordingLambda', {
            functionName: `${props.cdkAppName}-StartRecordingLambda`,
            runtime: lambda.Runtime.NODEJS_12_X,
            entry: 'lambdas/handlers/RecordingAPI/startRecording.js',
            timeout: cdk.Duration.seconds(20),
            environment: {
                DDB_TABLE: props.appTable.tableName,
                ECS_CLUSTER_ARN: props.recordingECSClusterARN,
                ECS_CONTAINER_NAME: props.recordingContainerName,
                ECS_TASK_DEFINITION_ARN: props.recordingTaskDefinitionARN,
                RECORDING_BUCKET_NAME: props.recordingBucketName,
                RECORDING_SCREEN_WIDTH: "1920",
                RECORDING_SCREEN_HEIGHT: "1080",
                RECORDING_ATTENDEE_NAME: props.SSMParams.recordingAttendeeName,
                ConnectInstanceId: props.SSMParams.connectInstanceARN.split('/')[1]
            }
        });
        props.appTable.grantReadWriteData(startRecordingLambda);
        (_a = startRecordingLambda.role) === null || _a === void 0 ? void 0 : _a.attachInlinePolicy(new iam.Policy(this, 'ChimeCreateAttendeeAccess', {
            statements: [
                new iam.PolicyStatement({
                    effect: iam.Effect.ALLOW,
                    actions: ['chime:CreateAttendee'],
                    resources: ['*']
                })
            ]
        }));
        (_b = startRecordingLambda.role) === null || _b === void 0 ? void 0 : _b.attachInlinePolicy(new iam.Policy(this, 'ECSRunTaskAccess', {
            statements: [
                new iam.PolicyStatement({
                    effect: iam.Effect.ALLOW,
                    actions: ['ecs:RunTask'],
                    resources: [props.recordingTaskDefinitionARN]
                })
            ]
        }));
        (_c = startRecordingLambda.role) === null || _c === void 0 ? void 0 : _c.attachInlinePolicy(new iam.Policy(this, 'IAMPassRoleAccess', {
            statements: [
                new iam.PolicyStatement({
                    effect: iam.Effect.ALLOW,
                    actions: ['iam:PassRole'],
                    resources: [props.recordingTaskDefinitionExecutionRoleARN]
                })
            ]
        }));
        (_d = startRecordingLambda.role) === null || _d === void 0 ? void 0 : _d.attachInlinePolicy(new iam.Policy(this, 'ConnectUpdateContactAttributesAccess', {
            statements: [
                new iam.PolicyStatement({
                    effect: iam.Effect.ALLOW,
                    actions: ['connect:UpdateContactAttributes'],
                    resources: [`${props.SSMParams.connectInstanceARN}/contact/*`]
                })
            ]
        }));
        //create stopRecording Lambda
        const stopRecordingLambda = new nodeLambda.NodejsFunction(this, 'StopRecordingLambda', {
            functionName: `${props.cdkAppName}-StopRecordingLambda`,
            runtime: lambda.Runtime.NODEJS_12_X,
            entry: 'lambdas/handlers/RecordingAPI/stopRecording.js',
            timeout: cdk.Duration.seconds(20),
            environment: {
                DDB_TABLE: props.appTable.tableName,
                ECS_CLUSTER_ARN: props.recordingECSClusterARN,
            }
        });
        props.appTable.grantReadWriteData(stopRecordingLambda);
        (_e = stopRecordingLambda.role) === null || _e === void 0 ? void 0 : _e.attachInlinePolicy(new iam.Policy(this, 'ECSStopTaskAccess', {
            statements: [
                new iam.PolicyStatement({
                    effect: iam.Effect.ALLOW,
                    actions: ['ecs:StopTask'],
                    resources: [`arn:aws:ecs:${this.region}:${this.account}:task/${props.recordingECSClusterName}/*`]
                })
            ]
        }));
        (_f = stopRecordingLambda.role) === null || _f === void 0 ? void 0 : _f.attachInlinePolicy(new iam.Policy(this, 'ChimeDeleteAttendeeAccess', {
            statements: [
                new iam.PolicyStatement({
                    effect: iam.Effect.ALLOW,
                    actions: ['chime:DeleteAttendee'],
                    resources: ['*']
                })
            ]
        }));
        //create getRecordingSummary Lambda
        const getRecordingSummaryLambda = new nodeLambda.NodejsFunction(this, 'GetRecordingSummaryLambda', {
            functionName: `${props.cdkAppName}-GetRecordingSummaryLambda`,
            runtime: lambda.Runtime.NODEJS_12_X,
            entry: 'lambdas/handlers/RecordingAPI/getRecordingSummary.js',
            timeout: cdk.Duration.seconds(20),
            environment: {
                DDB_TABLE: props.appTable.tableName,
                recordingPlaybackSecurityProfileId: props.SSMParams.recordingPlaybackSecurityProfileId,
                recordingPresignedURLExpiresMinutes: props.SSMParams.recordingPresignedURLExpiresMinutes
            }
        });
        props.appTable.grantReadData(getRecordingSummaryLambda);
        (_g = getRecordingSummaryLambda.role) === null || _g === void 0 ? void 0 : _g.attachInlinePolicy(new iam.Policy(this, 'S3PreSignedAccess', {
            statements: [
                new iam.PolicyStatement({
                    effect: iam.Effect.ALLOW,
                    actions: ['S3:GetObject'],
                    resources: [`arn:aws:s3:::${props.recordingBucketName}/RECORDINGS/*`]
                })
            ]
        }));
        const recordingAPI = new apigw2.HttpApi(this, 'RecordingAPI', {
            apiName: `${props.cdkAppName}-RecordingAPI`,
            corsPreflight: {
                allowOrigins: props.SSMParams.agentAPIAllowedOrigins.split(',').map((item) => item.trim()),
                allowMethods: [apigw2.CorsHttpMethod.GET, apigw2.CorsHttpMethod.POST, apigw2.CorsHttpMethod.DELETE],
                allowHeaders: apigw.Cors.DEFAULT_HEADERS.concat(['cognitoIdToken'])
            }
        });
        const startRecording_Route = new apigw2.HttpRoute(this, 'StartRecording_Route', {
            httpApi: recordingAPI,
            integration: new apigw2i.LambdaProxyIntegration({ handler: startRecordingLambda }),
            routeKey: apigw2.HttpRouteKey.with('/recording', apigw2.HttpMethod.POST)
        });
        const startRecording_RouteCfn = startRecording_Route.node.defaultChild;
        startRecording_RouteCfn.authorizationType = 'AWS_IAM';
        const stopRecording_Route = new apigw2.HttpRoute(this, 'StopRecording_Route', {
            httpApi: recordingAPI,
            integration: new apigw2i.LambdaProxyIntegration({ handler: stopRecordingLambda }),
            routeKey: apigw2.HttpRouteKey.with('/recording', apigw2.HttpMethod.DELETE)
        });
        const stopRecording_RouteCfn = stopRecording_Route.node.defaultChild;
        stopRecording_RouteCfn.authorizationType = 'AWS_IAM';
        const getRecordingSummary_Route = new apigw2.HttpRoute(this, 'GetRecordingSummary_Route', {
            httpApi: recordingAPI,
            integration: new apigw2i.LambdaProxyIntegration({ handler: getRecordingSummaryLambda }),
            routeKey: apigw2.HttpRouteKey.with('/recording-summary', apigw2.HttpMethod.GET)
        });
        const getRecordingSummary_RouteCfn = getRecordingSummary_Route.node.defaultChild;
        getRecordingSummary_RouteCfn.authorizationType = 'AWS_IAM';
        //Allow Identity Pool to invoke RecordingAPI resource
        props.cognitoAuthenticatedRole.attachInlinePolicy(new iam.Policy(this, 'RecordingAPI_StartRecordingResource', {
            statements: [new iam.PolicyStatement({
                    effect: iam.Effect.ALLOW,
                    actions: ["execute-api:Invoke"],
                    resources: [
                        `arn:aws:execute-api:${this.region}:${this.account}:${recordingAPI.httpApiId}/$default/${startRecording_RouteCfn.routeKey.replace(/\s+/g, '')}`,
                        `arn:aws:execute-api:${this.region}:${this.account}:${recordingAPI.httpApiId}/$default/${stopRecording_RouteCfn.routeKey.replace(/\s+/g, '')}`,
                        `arn:aws:execute-api:${this.region}:${this.account}:${recordingAPI.httpApiId}/$default/${getRecordingSummary_RouteCfn.routeKey.replace(/\s+/g, '')}`
                    ]
                })]
        }));
        this.recordingAPI = recordingAPI;
    }
}
exports.RecordingAPIStack = RecordingAPIStack;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVjb3JkaW5nQVBJLXN0YWNrLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsicmVjb3JkaW5nQVBJLXN0YWNrLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSwwRUFBMEU7QUFDMUUsaUNBQWlDOzs7QUFFakMscUNBQXFDO0FBQ3JDLHlEQUF5RDtBQUN6RCw4Q0FBOEM7QUFDOUMsaURBQWlEO0FBQ2pELG9EQUFvRDtBQUNwRCxrRUFBa0U7QUFFbEUsd0NBQXdDO0FBZXhDLE1BQWEsaUJBQWtCLFNBQVEsR0FBRyxDQUFDLFdBQVc7SUFJbEQsWUFBWSxLQUFvQixFQUFFLEVBQVUsRUFBRSxLQUE2Qjs7UUFDdkUsS0FBSyxDQUFDLEtBQUssRUFBRSxFQUFFLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFFeEIsOEJBQThCO1FBQzlCLE1BQU0sb0JBQW9CLEdBQUcsSUFBSSxVQUFVLENBQUMsY0FBYyxDQUFDLElBQUksRUFBRSxzQkFBc0IsRUFBRTtZQUNyRixZQUFZLEVBQUUsR0FBRyxLQUFLLENBQUMsVUFBVSx1QkFBdUI7WUFDeEQsT0FBTyxFQUFFLE1BQU0sQ0FBQyxPQUFPLENBQUMsV0FBVztZQUNuQyxLQUFLLEVBQUUsaURBQWlEO1lBQ3hELE9BQU8sRUFBRSxHQUFHLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxFQUFFLENBQUM7WUFDakMsV0FBVyxFQUFFO2dCQUNULFNBQVMsRUFBRSxLQUFLLENBQUMsUUFBUSxDQUFDLFNBQVM7Z0JBQ25DLGVBQWUsRUFBRSxLQUFLLENBQUMsc0JBQXNCO2dCQUM3QyxrQkFBa0IsRUFBRSxLQUFLLENBQUMsc0JBQXNCO2dCQUNoRCx1QkFBdUIsRUFBRSxLQUFLLENBQUMsMEJBQTBCO2dCQUN6RCxxQkFBcUIsRUFBRSxLQUFLLENBQUMsbUJBQW1CO2dCQUNoRCxzQkFBc0IsRUFBRSxNQUFNO2dCQUM5Qix1QkFBdUIsRUFBRSxNQUFNO2dCQUMvQix1QkFBdUIsRUFBRSxLQUFLLENBQUMsU0FBUyxDQUFDLHFC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SUFDcEMsQ0FBQztDQUNKO0FBL0tELDhDQStLQyIsInNvdXJjZXNDb250ZW50IjpbIi8vIENvcHlyaWdodCAyMDIxIEFtYXpvbi5jb20sIEluYy4gb3IgaXRzIGFmZmlsaWF0ZXMuIEFsbCBSaWdodHMgUmVzZXJ2ZWQuXG4vLyBTUERYLUxpY2Vuc2UtSWRlbnRpZmllcjogTUlULTBcblxuaW1wb3J0ICogYXMgY2RrIGZyb20gJ0Bhd3MtY2RrL2NvcmUnO1xuaW1wb3J0ICogYXMgbm9kZUxhbWJkYSBmcm9tIFwiQGF3cy1jZGsvYXdzLWxhbWJkYS1ub2RlanNcIjtcbmltcG9ydCAqIGFzIGxhbWJkYSBmcm9tICdAYXdzLWNkay9hd3MtbGFtYmRhJztcbmltcG9ydCAqIGFzIGFwaWd3IGZyb20gJ0Bhd3MtY2RrL2F3cy1hcGlnYXRld2F5JztcbmltcG9ydCAqIGFzIGFwaWd3MiBmcm9tIFwiQGF3cy1jZGsvYXdzLWFwaWdhdGV3YXl2MlwiO1xuaW1wb3J0ICogYXMgYXBpZ3cyaSBmcm9tIFwiQGF3cy1jZGsvYXdzLWFwaWdhdGV3YXl2Mi1pbnRlZ3JhdGlvbnNcIjtcbmltcG9ydCAqIGFzIGRkYiBmcm9tICdAYXdzLWNkay9hd3MtZHluYW1vZGInO1xuaW1wb3J0ICogYXMgaWFtIGZyb20gJ0Bhd3MtY2RrL2F3cy1pYW0nO1xuXG5leHBvcnQgaW50ZXJmYWNlIFJlY29yZGluZ0FQSVN0YWNrUHJvcHMgZXh0ZW5kcyBjZGsuTmVzdGVkU3RhY2tQcm9wcyB7XG4gICAgcmVhZG9ubHkgU1NNUGFyYW1zOiBhbnk7XG4gICAgcmVhZG9ubHkgY29nbml0b0F1dGhlbnRpY2F0ZWRSb2xlOiBpYW0uSVJvbGU7XG4gICAgcmVhZG9ubHkgYXBwVGFibGU6IGRkYi5JVGFibGU7XG4gICAgcmVhZG9ubHkgY2RrQXBwTmFtZTogc3RyaW5nO1xuICAgIHJlYWRvbmx5IHJlY29yZGluZ0VDU0NsdXN0ZXJBUk46IHN0cmluZztcbiAgICByZWFkb25seSByZWNvcmRpbmdFQ1NDbHVzdGVyTmFtZTogc3RyaW5nO1xuICAgIHJlYWRvbmx5IHJlY29yZGluZ0NvbnRhaW5lck5hbWU6IHN0cmluZztcbiAgICByZWFkb25seSByZWNvcmRpbmdUYXNrRGVmaW5pdGlvbkFSTjogc3RyaW5nO1xuICAgIHJlYWRvbmx5IHJlY29yZGluZ0J1Y2tldE5hbWU6IHN0cmluZztcbiAgICByZWFkb25seSByZWNvcmRpbmdUYXNrRGVmaW5pdGlvbkV4ZWN1dGlvblJvbGVBUk46IHN0cmluZztcbn1cblxuZXhwb3J0IGNsYXNzIFJlY29yZGluZ0FQSVN0YWNrIGV4dGVuZHMgY2RrLk5lc3RlZFN0YWNrIHtcblxuICAgIHB1YmxpYyByZWFkb25seSByZWNvcmRpbmdBUEk6IGFwaWd3Mi5JSHR0cEFwaTtcblxuICAgIGNvbnN0cnVjdG9yKHNjb3BlOiBjZGsuQ29uc3RydWN0LCBpZDogc3RyaW5nLCBwcm9wczogUmVjb3JkaW5nQVBJU3RhY2tQcm9wcykge1xuICAgICAgICBzdXBlcihzY29wZSwgaWQsIHByb3BzKTtcblxuICAgICAgICAvL2NyZWF0ZSBzdGFydFJlY29yZGluZyBMYW1iZGFcbiAgICAgICAgY29uc3Qgc3RhcnRSZWNvcmRpbmdMYW1iZGEgPSBuZXcgbm9kZUxhbWJkYS5Ob2RlanNGdW5jdGlvbih0aGlzLCAnU3RhcnRSZWNvcmRpbmdMYW1iZGEnLCB7XG4gICAgICAgICAgICBmdW5jdGlvbk5hbWU6IGAke3Byb3BzLmNka0FwcE5hbWV9LVN0YXJ0UmVjb3JkaW5nTGFtYmRhYCxcbiAgICAgICAgICAgIHJ1bnRpbWU6IGxhbWJkYS5SdW50aW1lLk5PREVKU18xMl9YLFxuICAgICAgICAgICAgZW50cnk6ICdsYW1iZGFzL2hhbmRsZXJzL1JlY29yZGluZ0FQSS9zdGFydFJlY29yZGluZy5qcycsXG4gICAgICAgICAgICB0aW1lb3V0OiBjZGsuRHVyYXRpb24uc2Vjb25kcygyMCksXG4gICAgICAgICAgICBlbnZpcm9ubWVudDoge1xuICAgICAgICAgICAgICAgIEREQl9UQUJMRTogcHJvcHMuYXBwVGFibGUudGFibGVOYW1lLFxuICAgICAgICAgICAgICAgIEVDU19DTFVTVEVSX0FSTjogcHJvcHMucmVjb3JkaW5nRUNTQ2x1c3RlckFSTixcbiAgICAgICAgICAgICAgICBFQ1NfQ09OVEFJTkVSX05BTUU6IHByb3BzLnJlY29yZGluZ0NvbnRhaW5lck5hbWUsXG4gICAgICAgICAgICAgICAgRUNTX1RBU0tfREVGSU5JVElPTl9BUk46IHByb3BzLnJlY29yZGluZ1Rhc2tEZWZpbml0aW9uQVJOLFxuICAgICAgICAgICAgICAgIFJFQ09SRElOR19CVUNLRVRfTkFNRTogcHJvcHMucmVjb3JkaW5nQnVja2V0TmFtZSxcbiAgICAgICAgICAgICAgICBSRUNPUkRJTkdfU0NSRUVOX1dJRFRIOiBcIjE5MjBcIixcbiAgICAgICAgICAgICAgICBSRUNPUkRJTkdfU0NSRUVOX0hFSUdIVDogXCIxMDgwXCIsXG4gICAgICAgICAgICAgICAgUkVDT1JESU5HX0FUVEVOREVFX05BTUU6IHByb3BzLlNTTVBhcmFtcy5yZWNvcmRpbmdBdHRlbmRlZU5hbWUsXG4gICAgICAgICAgICAgICAgQ29ubmVjdEluc3RhbmNlSWQ6IHByb3BzLlNTTVBhcmFtcy5jb25uZWN0SW5zdGFuY2VBUk4uc3BsaXQoJy8nKVsxXVxuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgICAgcHJvcHMuYXBwVGFibGUuZ3JhbnRSZWFkV3JpdGVEYXRhKHN0YXJ0UmVjb3JkaW5nTGFtYmRhKTtcblxuICAgICAgICBzdGFydFJlY29yZGluZ0xhbWJkYS5yb2xlPy5hdHRhY2hJbmxpbmVQb2xpY3kobmV3IGlhbS5Qb2xpY3kodGhpcywgJ0NoaW1lQ3JlYXRlQXR0ZW5kZWVBY2Nlc3MnLCB7XG4gICAgICAgICAgICBzdGF0ZW1lbnRzOiBbXG4gICAgICAgICAgICAgICAgbmV3IGlhbS5Qb2xpY3lTdGF0ZW1lbnQoe1xuICAgICAgICAgICAgICAgICAgICBlZmZlY3Q6IGlhbS5FZmZlY3QuQUxMT1csXG4gICAgICAgICAgICAgICAgICAgIGFjdGlvbnM6IFsnY2hpbWU6Q3JlYXRlQXR0ZW5kZWUnXSxcbiAgICAgICAgICAgICAgICAgICAgcmVzb3VyY2VzOiBbJyonXVxuICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICBdXG4gICAgICAgIH0pKTtcblxuICAgICAgICBzdGFydFJlY29yZGluZ0xhbWJkYS5yb2xlPy5hdHRhY2hJbmxpbmVQb2xpY3kobmV3IGlhbS5Qb2xpY3kodGhpcywgJ0VDU1J1blRhc2tBY2Nlc3MnLCB7XG4gICAgICAgICAgICBzdGF0ZW1lbnRzOiBbXG4gICAgICAgICAgICAgICAgbmV3IGlhbS5Qb2xpY3lTdGF0ZW1lbnQoe1xuICAgICAgICAgICAgICAgICAgICBlZmZlY3Q6IGlhbS5FZmZlY3QuQUxMT1csXG4gICAgICAgICAgICAgICAgICAgIGFjdGlvbnM6IFsnZWNzOlJ1blRhc2snXSxcbiAgICAgICAgICAgICAgICAgICAgcmVzb3VyY2VzOiBbcHJvcHMucmVjb3JkaW5nVGFza0RlZmluaXRpb25BUk5dXG4gICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIF1cbiAgICAgICAgfSkpO1xuXG4gICAgICAgIHN0YXJ0UmVjb3JkaW5nTGFtYmRhLnJvbGU/LmF0dGFjaElubGluZVBvbGljeShuZXcgaWFtLlBvbGljeSh0aGlzLCAnSUFNUGFzc1JvbGVBY2Nlc3MnLCB7XG4gICAgICAgICAgICBzdGF0ZW1lbnRzOiBbXG4gICAgICAgICAgICAgICAgbmV3IGlhbS5Qb2xpY3lTdGF0ZW1lbnQoe1xuICAgICAgICAgICAgICAgICAgICBlZmZlY3Q6IGlhbS5FZmZlY3QuQUxMT1csXG4gICAgICAgICAgICAgICAgICAgIGFjdGlvbnM6IFsnaWFtOlBhc3NSb2xlJ10sXG4gICAgICAgICAgICAgICAgICAgIHJlc291cmNlczogW3Byb3BzLnJlY29yZGluZ1Rhc2tEZWZpbml0aW9uRXhlY3V0aW9uUm9sZUFSTl1cbiAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgXVxuICAgICAgICB9KSk7XG5cbiAgICAgICAgc3RhcnRSZWNvcmRpbmdMYW1iZGEucm9sZT8uYXR0YWNoSW5saW5lUG9saWN5KG5ldyBpYW0uUG9saWN5KHRoaXMsICdDb25uZWN0VXBkYXRlQ29udGFjdEF0dHJpYnV0ZXNBY2Nlc3MnLCB7XG4gICAgICAgICAgICBzdGF0ZW1lbnRzOiBbXG4gICAgICAgICAgICAgICAgbmV3IGlhbS5Qb2xpY3lTdGF0ZW1lbnQoe1xuICAgICAgICAgICAgICAgICAgICBlZmZlY3Q6IGlhbS5FZmZlY3QuQUxMT1csXG4gICAgICAgICAgICAgICAgICAgIGFjdGlvbnM6IFsnY29ubmVjdDpVcGRhdGVDb250YWN0QXR0cmlidXRlcyddLFxuICAgICAgICAgICAgICAgICAgICByZXNvdXJjZXM6IFtgJHtwcm9wcy5TU01QYXJhbXMuY29ubmVjdEluc3RhbmNlQVJOfS9jb250YWN0LypgXVxuICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICBdXG4gICAgICAgIH0pKTtcblxuXG4gICAgICAgIC8vY3JlYXRlIHN0b3BSZWNvcmRpbmcgTGFtYmRhXG4gICAgICAgIGNvbnN0IHN0b3BSZWNvcmRpbmdMYW1iZGEgPSBuZXcgbm9kZUxhbWJkYS5Ob2RlanNGdW5jdGlvbih0aGlzLCAnU3RvcFJlY29yZGluZ0xhbWJkYScsIHtcbiAgICAgICAgICAgIGZ1bmN0aW9uTmFtZTogYCR7cHJvcHMuY2RrQXBwTmFtZX0tU3RvcFJlY29yZGluZ0xhbWJkYWAsXG4gICAgICAgICAgICBydW50aW1lOiBsYW1iZGEuUnVudGltZS5OT0RFSlNfMTJfWCxcbiAgICAgICAgICAgIGVudHJ5OiAnbGFtYmRhcy9oYW5kbGVycy9SZWNvcmRpbmdBUEkvc3RvcFJlY29yZGluZy5qcycsXG4gICAgICAgICAgICB0aW1lb3V0OiBjZGsuRHVyYXRpb24uc2Vjb25kcygyMCksXG4gICAgICAgICAgICBlbnZpcm9ubWVudDoge1xuICAgICAgICAgICAgICAgIEREQl9UQUJMRTogcHJvcHMuYXBwVGFibGUudGFibGVOYW1lLFxuICAgICAgICAgICAgICAgIEVDU19DTFVTVEVSX0FSTjogcHJvcHMucmVjb3JkaW5nRUNTQ2x1c3RlckFSTixcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICAgIHByb3BzLmFwcFRhYmxlLmdyYW50UmVhZFdyaXRlRGF0YShzdG9wUmVjb3JkaW5nTGFtYmRhKTtcblxuICAgICAgICBzdG9wUmVjb3JkaW5nTGFtYmRhLnJvbGU/LmF0dGFjaElubGluZVBvbGljeShuZXcgaWFtLlBvbGljeSh0aGlzLCAnRUNTU3RvcFRhc2tBY2Nlc3MnLCB7XG4gICAgICAgICAgICBzdGF0ZW1lbnRzOiBbXG4gICAgICAgICAgICAgICAgbmV3IGlhbS5Qb2xpY3lTdGF0ZW1lbnQoe1xuICAgICAgICAgICAgICAgICAgICBlZmZlY3Q6IGlhbS5FZmZlY3QuQUxMT1csXG4gICAgICAgICAgICAgICAgICAgIGFjdGlvbnM6IFsnZWNzOlN0b3BUYXNrJ10sXG4gICAgICAgICAgICAgICAgICAgIHJlc291cmNlczogW2Bhcm46YXdzOmVjczoke3RoaXMucmVnaW9ufToke3RoaXMuYWNjb3VudH06dGFzay8ke3Byb3BzLnJlY29yZGluZ0VDU0NsdXN0ZXJOYW1lfS8qYF1cbiAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgXVxuICAgICAgICB9KSk7XG5cbiAgICAgICAgc3RvcFJlY29yZGluZ0xhbWJkYS5yb2xlPy5hdHRhY2hJbmxpbmVQb2xpY3kobmV3IGlhbS5Qb2xpY3kodGhpcywgJ0NoaW1lRGVsZXRlQXR0ZW5kZWVBY2Nlc3MnLCB7XG4gICAgICAgICAgICBzdGF0ZW1lbnRzOiBbXG4gICAgICAgICAgICAgICAgbmV3IGlhbS5Qb2xpY3lTdGF0ZW1lbnQoe1xuICAgICAgICAgICAgICAgICAgICBlZmZlY3Q6IGlhbS5FZmZlY3QuQUxMT1csXG4gICAgICAgICAgICAgICAgICAgIGFjdGlvbnM6IFsnY2hpbWU6RGVsZXRlQXR0ZW5kZWUnXSxcbiAgICAgICAgICAgICAgICAgICAgcmVzb3VyY2VzOiBbJyonXVxuICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICBdXG4gICAgICAgIH0pKTtcblxuXG4gICAgICAgIC8vY3JlYXRlIGdldFJlY29yZGluZ1N1bW1hcnkgTGFtYmRhXG4gICAgICAgIGNvbnN0IGdldFJlY29yZGluZ1N1bW1hcnlMYW1iZGEgPSBuZXcgbm9kZUxhbWJkYS5Ob2RlanNGdW5jdGlvbih0aGlzLCAnR2V0UmVjb3JkaW5nU3VtbWFyeUxhbWJkYScsIHtcbiAgICAgICAgICAgIGZ1bmN0aW9uTmFtZTogYCR7cHJvcHMuY2RrQXBwTmFtZX0tR2V0UmVjb3JkaW5nU3VtbWFyeUxhbWJkYWAsXG4gICAgICAgICAgICBydW50aW1lOiBsYW1iZGEuUnVudGltZS5OT0RFSlNfMTJfWCxcbiAgICAgICAgICAgIGVudHJ5OiAnbGFtYmRhcy9oYW5kbGVycy9SZWNvcmRpbmdBUEkvZ2V0UmVjb3JkaW5nU3VtbWFyeS5qcycsXG4gICAgICAgICAgICB0aW1lb3V0OiBjZGsuRHVyYXRpb24uc2Vjb25kcygyMCksXG4gICAgICAgICAgICBlbnZpcm9ubWVudDoge1xuICAgICAgICAgICAgICAgIEREQl9UQUJMRTogcHJvcHMuYXBwVGFibGUudGFibGVOYW1lLFxuICAgICAgICAgICAgICAgIHJlY29yZGluZ1BsYXliYWNrU2VjdXJpdHlQcm9maWxlSWQ6IHByb3BzLlNTTVBhcmFtcy5yZWNvcmRpbmdQbGF5YmFja1NlY3VyaXR5UHJvZmlsZUlkLFxuICAgICAgICAgICAgICAgIHJlY29yZGluZ1ByZXNpZ25lZFVSTEV4cGlyZXNNaW51dGVzOiBwcm9wcy5TU01QYXJhbXMucmVjb3JkaW5nUHJlc2lnbmVkVVJMRXhwaXJlc01pbnV0ZXNcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICAgIHByb3BzLmFwcFRhYmxlLmdyYW50UmVhZERhdGEoZ2V0UmVjb3JkaW5nU3VtbWFyeUxhbWJkYSk7XG5cbiAgICAgICAgZ2V0UmVjb3JkaW5nU3VtbWFyeUxhbWJkYS5yb2xlPy5hdHRhY2hJbmxpbmVQb2xpY3kobmV3IGlhbS5Qb2xpY3kodGhpcywgJ1MzUHJlU2lnbmVkQWNjZXNzJywge1xuICAgICAgICAgICAgc3RhdGVtZW50czogW1xuICAgICAgICAgICAgICAgIG5ldyBpYW0uUG9saWN5U3RhdGVtZW50KHtcbiAgICAgICAgICAgICAgICAgICAgZWZmZWN0OiBpYW0uRWZmZWN0LkFMTE9XLFxuICAgICAgICAgICAgICAgICAgICBhY3Rpb25zOiBbJ1MzOkdldE9iamVjdCddLFxuICAgICAgICAgICAgICAgICAgICByZXNvdXJjZXM6IFtgYXJuOmF3czpzMzo6OiR7cHJvcHMucmVjb3JkaW5nQnVja2V0TmFtZX0vUkVDT1JESU5HUy8qYF1cbiAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgXVxuICAgICAgICB9KSlcblxuXG4gICAgICAgIGNvbnN0IHJlY29yZGluZ0FQSSA9IG5ldyBhcGlndzIuSHR0cEFwaSh0aGlzLCAnUmVjb3JkaW5nQVBJJywge1xuICAgICAgICAgICAgYXBpTmFtZTogYCR7cHJvcHMuY2RrQXBwTmFtZX0tUmVjb3JkaW5nQVBJYCxcbiAgICAgICAgICAgIGNvcnNQcmVmbGlnaHQ6IHtcbiAgICAgICAgICAgICAgICBhbGxvd09yaWdpbnM6IHByb3BzLlNTTVBhcmFtcy5hZ2VudEFQSUFsbG93ZWRPcmlnaW5zLnNwbGl0KCcsJykubWFwKChpdGVtOiBzdHJpbmcpID0+IGl0ZW0udHJpbSgpKSxcbiAgICAgICAgICAgICAgICBhbGxvd01ldGhvZHM6IFthcGlndzIuQ29yc0h0dHBNZXRob2QuR0VULCBhcGlndzIuQ29yc0h0dHBNZXRob2QuUE9TVCwgYXBpZ3cyLkNvcnNIdHRwTWV0aG9kLkRFTEVURV0sXG4gICAgICAgICAgICAgICAgYWxsb3dIZWFkZXJzOiBhcGlndy5Db3JzLkRFRkFVTFRfSEVBREVSUy5jb25jYXQoWydjb2duaXRvSWRUb2tlbiddKVxuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcblxuICAgICAgICBjb25zdCBzdGFydFJlY29yZGluZ19Sb3V0ZSA9IG5ldyBhcGlndzIuSHR0cFJvdXRlKHRoaXMsICdTdGFydFJlY29yZGluZ19Sb3V0ZScsIHtcbiAgICAgICAgICAgIGh0dHBBcGk6IHJlY29yZGluZ0FQSSxcbiAgICAgICAgICAgIGludGVncmF0aW9uOiBuZXcgYXBpZ3cyaS5MYW1iZGFQcm94eUludGVncmF0aW9uKHsgaGFuZGxlcjogc3RhcnRSZWNvcmRpbmdMYW1iZGEgfSksXG4gICAgICAgICAgICByb3V0ZUtleTogYXBpZ3cyLkh0dHBSb3V0ZUtleS53aXRoKCcvcmVjb3JkaW5nJywgYXBpZ3cyLkh0dHBNZXRob2QuUE9TVClcbiAgICAgICAgfSk7XG4gICAgICAgIGNvbnN0IHN0YXJ0UmVjb3JkaW5nX1JvdXRlQ2ZuID0gc3RhcnRSZWNvcmRpbmdfUm91dGUubm9kZS5kZWZhdWx0Q2hpbGQgYXMgYXBpZ3cyLkNmblJvdXRlO1xuICAgICAgICBzdGFydFJlY29yZGluZ19Sb3V0ZUNmbi5hdXRob3JpemF0aW9uVHlwZSA9ICdBV1NfSUFNJztcblxuICAgICAgICBjb25zdCBzdG9wUmVjb3JkaW5nX1JvdXRlID0gbmV3IGFwaWd3Mi5IdHRwUm91dGUodGhpcywgJ1N0b3BSZWNvcmRpbmdfUm91dGUnLCB7XG4gICAgICAgICAgICBodHRwQXBpOiByZWNvcmRpbmdBUEksXG4gICAgICAgICAgICBpbnRlZ3JhdGlvbjogbmV3IGFwaWd3MmkuTGFtYmRhUHJveHlJbnRlZ3JhdGlvbih7IGhhbmRsZXI6IHN0b3BSZWNvcmRpbmdMYW1iZGEgfSksXG4gICAgICAgICAgICByb3V0ZUtleTogYXBpZ3cyLkh0dHBSb3V0ZUtleS53aXRoKCcvcmVjb3JkaW5nJywgYXBpZ3cyLkh0dHBNZXRob2QuREVMRVRFKVxuICAgICAgICB9KTtcbiAgICAgICAgY29uc3Qgc3RvcFJlY29yZGluZ19Sb3V0ZUNmbiA9IHN0b3BSZWNvcmRpbmdfUm91dGUubm9kZS5kZWZhdWx0Q2hpbGQgYXMgYXBpZ3cyLkNmblJvdXRlO1xuICAgICAgICBzdG9wUmVjb3JkaW5nX1JvdXRlQ2ZuLmF1dGhvcml6YXRpb25UeXBlID0gJ0FXU19JQU0nO1xuXG4gICAgICAgIGNvbnN0IGdldFJlY29yZGluZ1N1bW1hcnlfUm91dGUgPSBuZXcgYXBpZ3cyLkh0dHBSb3V0ZSh0aGlzLCAnR2V0UmVjb3JkaW5nU3VtbWFyeV9Sb3V0ZScsIHtcbiAgICAgICAgICAgIGh0dHBBcGk6IHJlY29yZGluZ0FQSSxcbiAgICAgICAgICAgIGludGVncmF0aW9uOiBuZXcgYXBpZ3cyaS5MYW1iZGFQcm94eUludGVncmF0aW9uKHsgaGFuZGxlcjogZ2V0UmVjb3JkaW5nU3VtbWFyeUxhbWJkYSB9KSxcbiAgICAgICAgICAgIHJvdXRlS2V5OiBhcGlndzIuSHR0cFJvdXRlS2V5LndpdGgoJy9yZWNvcmRpbmctc3VtbWFyeScsIGFwaWd3Mi5IdHRwTWV0aG9kLkdFVClcbiAgICAgICAgfSk7XG4gICAgICAgIGNvbnN0IGdldFJlY29yZGluZ1N1bW1hcnlfUm91dGVDZm4gPSBnZXRSZWNvcmRpbmdTdW1tYXJ5X1JvdXRlLm5vZGUuZGVmYXVsdENoaWxkIGFzIGFwaWd3Mi5DZm5Sb3V0ZTtcbiAgICAgICAgZ2V0UmVjb3JkaW5nU3VtbWFyeV9Sb3V0ZUNmbi5hdXRob3JpemF0aW9uVHlwZSA9ICdBV1NfSUFNJztcblxuICAgICAgICAvL0FsbG93IElkZW50aXR5IFBvb2wgdG8gaW52b2tlIFJlY29yZGluZ0FQSSByZXNvdXJjZVxuICAgICAgICBwcm9wcy5jb2duaXRvQXV0aGVudGljYXRlZFJvbGUuYXR0YWNoSW5saW5lUG9saWN5KG5ldyBpYW0uUG9saWN5KHRoaXMsICdSZWNvcmRpbmdBUElfU3RhcnRSZWNvcmRpbmdSZXNvdXJjZScsIHtcbiAgICAgICAgICAgIHN0YXRlbWVudHM6IFtuZXcgaWFtLlBvbGljeVN0YXRlbWVudCh7XG4gICAgICAgICAgICAgICAgZWZmZWN0OiBpYW0uRWZmZWN0LkFMTE9XLFxuICAgICAgICAgICAgICAgIGFjdGlvbnM6IFtcImV4ZWN1dGUtYXBpOkludm9rZVwiXSxcbiAgICAgICAgICAgICAgICByZXNvdXJjZXM6IFtcbiAgICAgICAgICAgICAgICAgICAgYGFybjphd3M6ZXhlY3V0ZS1hcGk6JHt0aGlzLnJlZ2lvbn06JHt0aGlzLmFjY291bnR9OiR7cmVjb3JkaW5nQVBJLmh0dHBBcGlJZH0vJGRlZmF1bHQvJHtzdGFydFJlY29yZGluZ19Sb3V0ZUNmbi5yb3V0ZUtleS5yZXBsYWNlKC9cXHMrL2csICcnKX1gLFxuICAgICAgICAgICAgICAgICAgICBgYXJuOmF3czpleGVjdXRlLWFwaToke3RoaXMucmVnaW9ufToke3RoaXMuYWNjb3VudH06JHtyZWNvcmRpbmdBUEkuaHR0cEFwaUlkfS8kZGVmYXVsdC8ke3N0b3BSZWNvcmRpbmdfUm91dGVDZm4ucm91dGVLZXkucmVwbGFjZSgvXFxzKy9nLCAnJyl9YCxcbiAgICAgICAgICAgICAgICAgICAgYGFybjphd3M6ZXhlY3V0ZS1hcGk6JHt0aGlzLnJlZ2lvbn06JHt0aGlzLmFjY291bnR9OiR7cmVjb3JkaW5nQVBJLmh0dHBBcGlJZH0vJGRlZmF1bHQvJHtnZXRSZWNvcmRpbmdTdW1tYXJ5X1JvdXRlQ2ZuLnJvdXRlS2V5LnJlcGxhY2UoL1xccysvZywgJycpfWBcbiAgICAgICAgICAgICAgICBdXG4gICAgICAgICAgICB9KV1cbiAgICAgICAgfSkpO1xuXG4gICAgICAgIHRoaXMucmVjb3JkaW5nQVBJID0gcmVjb3JkaW5nQVBJXG4gICAgfVxufSJdfQ==