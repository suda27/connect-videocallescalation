"use strict";
// Copyright 2021 Amazon.com, Inc. or its affiliates. All Rights Reserved.
// SPDX-License-Identifier: MIT-0
Object.defineProperty(exports, "__esModule", { value: true });
exports.ConnectAPIStack = void 0;
const cdk = require("@aws-cdk/core");
const nodeLambda = require("@aws-cdk/aws-lambda-nodejs");
const lambda = require("@aws-cdk/aws-lambda");
const iam = require("@aws-cdk/aws-iam");
const apigw = require("@aws-cdk/aws-apigateway");
const apigw2 = require("@aws-cdk/aws-apigatewayv2");
const apigw2i = require("@aws-cdk/aws-apigatewayv2-integrations");
class ConnectAPIStack extends cdk.NestedStack {
    constructor(scope, id, props) {
        var _a, _b, _c, _d, _e, _f, _g;
        super(scope, id, props);
        const ccpLoginLambda = new nodeLambda.NodejsFunction(this, 'CCPLoginLambda', {
            functionName: `${props.cdkAppName}-CCPLoginLambda`,
            runtime: lambda.Runtime.NODEJS_12_X,
            entry: 'lambdas/handlers/ConnectAPI/ccpLogin.js',
            timeout: cdk.Duration.seconds(20),
            environment: {
                ConnectInstanceId: props.SSMParams.connectInstanceARN.split('/')[1],
            }
        });
        //Allow connectAPILambda to invoke Amazon Connect
        (_a = ccpLoginLambda.role) === null || _a === void 0 ? void 0 : _a.attachInlinePolicy(new iam.Policy(this, 'ConnectGetFederationTokenAccess', {
            statements: [
                new iam.PolicyStatement({
                    effect: iam.Effect.ALLOW,
                    actions: ["connect:GetFederationToken"],
                    resources: [props.SSMParams.connectInstanceARN + '/user/*']
                })
            ]
        }));
        //Allow connectAPILambda to invoke STS
        (_b = ccpLoginLambda.role) === null || _b === void 0 ? void 0 : _b.attachInlinePolicy(new iam.Policy(this, 'STSAssumeRoleAccess', {
            statements: [
                new iam.PolicyStatement({
                    effect: iam.Effect.ALLOW,
                    actions: ["sts:AssumeRole"],
                    resources: [props.SSMParams.ccpLoginLambdaRoleToAssume === props.SSMParams.SSM_NOT_DEFINED ? ccpLoginLambda.role.roleArn : props.SSMParams.ccpLoginLambdaRoleToAssume]
                })
            ]
        }));
        //add env variable - RoleToAssume
        ccpLoginLambda.addEnvironment('RoleToAssume', props.SSMParams.ccpLoginLambdaRoleToAssume === props.SSMParams.SSM_NOT_DEFINED ? ((_c = ccpLoginLambda.role) === null || _c === void 0 ? void 0 : _c.roleArn) || '' : props.SSMParams.ccpLoginLambdaRoleToAssume);
        const putConnectUserCacheLambda = new nodeLambda.NodejsFunction(this, 'PutConnectUserCacheLambda', {
            functionName: `${props.cdkAppName}-PutConnectUserCacheLambda`,
            runtime: lambda.Runtime.NODEJS_12_X,
            entry: 'lambdas/handlers/ConnectAPI/putConnectUserCache.js',
            timeout: cdk.Duration.seconds(20),
            environment: {
                ConnectInstanceId: props.SSMParams.connectInstanceARN.split('/')[1],
                DDB_TABLE: props.appTable.tableName
            }
        });
        props.appTable.grantReadWriteData(putConnectUserCacheLambda);
        (_d = putConnectUserCacheLambda.role) === null || _d === void 0 ? void 0 : _d.attachInlinePolicy(new iam.Policy(this, 'ConnectDescribeUserAccess', {
            statements: [
                new iam.PolicyStatement({
                    effect: iam.Effect.ALLOW,
                    actions: ["connect:DescribeUser"],
                    resources: [
                        props.SSMParams.connectInstanceARN + '/user/*',
                        props.SSMParams.connectInstanceARN + '/agent/*'
                    ]
                })
            ]
        }));
        (_e = putConnectUserCacheLambda.role) === null || _e === void 0 ? void 0 : _e.attachInlinePolicy(new iam.Policy(this, 'ConnectDescribeUserHierarchyGroupAccess', {
            statements: [
                new iam.PolicyStatement({
                    effect: iam.Effect.ALLOW,
                    actions: ["connect:DescribeUserHierarchyGroup"],
                    resources: [props.SSMParams.connectInstanceARN + '/agent-group/*']
                })
            ]
        }));
        const setConnectUserIdLambda = new nodeLambda.NodejsFunction(this, 'SetConnectUserIdLambda', {
            functionName: `${props.cdkAppName}-SetConnectUserIdLambda`,
            runtime: lambda.Runtime.NODEJS_12_X,
            entry: 'lambdas/handlers/ConnectAPI/setConnectUserId.js',
            timeout: cdk.Duration.seconds(20),
            environment: {
                ConnectInstanceId: props.SSMParams.connectInstanceARN.split('/')[1],
                CognitoUserPoolId: props.cognitoUserPoolId,
                DDB_TABLE: props.appTable.tableName
            }
        });
        (_f = setConnectUserIdLambda.role) === null || _f === void 0 ? void 0 : _f.attachInlinePolicy(new iam.Policy(this, 'ConnectDescribeUserAccess2', {
            statements: [
                new iam.PolicyStatement({
                    effect: iam.Effect.ALLOW,
                    actions: ["connect:DescribeUser"],
                    resources: [
                        props.SSMParams.connectInstanceARN + '/user/*',
                        props.SSMParams.connectInstanceARN + '/agent/*'
                    ]
                })
            ]
        }));
        (_g = setConnectUserIdLambda.role) === null || _g === void 0 ? void 0 : _g.attachInlinePolicy(new iam.Policy(this, 'CognitoUpdateUserAttributesAccess', {
            statements: [
                new iam.PolicyStatement({
                    effect: iam.Effect.ALLOW,
                    actions: ["cognito-idp:AdminUpdateUserAttributes"],
                    resources: [props.cognitoUserPoolARN]
                })
            ]
        }));
        //create ConnectAPI Integration
        const connectAPI = new apigw2.HttpApi(this, 'ConnectAPI', {
            apiName: `${props.cdkAppName}-ConnectAPI`,
            corsPreflight: {
                allowOrigins: props.SSMParams.agentAPIAllowedOrigins.split(',').map((item) => item.trim()),
                allowMethods: [apigw2.CorsHttpMethod.POST, apigw2.CorsHttpMethod.PUT],
                allowHeaders: apigw.Cors.DEFAULT_HEADERS.concat(['cognitoIdToken'])
            }
        });
        const ccpLogin_Route = new apigw2.HttpRoute(this, 'CCPLogin_Route', {
            httpApi: connectAPI,
            integration: new apigw2i.LambdaProxyIntegration({ handler: ccpLoginLambda }),
            routeKey: apigw2.HttpRouteKey.with('/ccplogin', apigw2.HttpMethod.POST)
        });
        const ccpLogin_RouteCfn = ccpLogin_Route.node.defaultChild;
        ccpLogin_RouteCfn.authorizationType = 'AWS_IAM';
        const setConnectUserId_Route = new apigw2.HttpRoute(this, 'SetConnectUserId_Route', {
            httpApi: connectAPI,
            integration: new apigw2i.LambdaProxyIntegration({ handler: setConnectUserIdLambda }),
            routeKey: apigw2.HttpRouteKey.with('/setConnectUserId', apigw2.HttpMethod.POST)
        });
        const setConnectUserId_RouteCfn = setConnectUserId_Route.node.defaultChild;
        setConnectUserId_RouteCfn.authorizationType = 'AWS_IAM';
        const putConnectUserCache_Route = new apigw2.HttpRoute(this, 'PutConnectUserCache_Route', {
            httpApi: connectAPI,
            integration: new apigw2i.LambdaProxyIntegration({ handler: putConnectUserCacheLambda }),
            routeKey: apigw2.HttpRouteKey.with('/connect-user-cache', apigw2.HttpMethod.PUT)
        });
        const putConnectUserCache_RouteCfn = putConnectUserCache_Route.node.defaultChild;
        putConnectUserCache_RouteCfn.authorizationType = 'AWS_IAM';
        //Allow Identity Pool to invoke ConnectAPI Login resource
        props.cognitoAuthenticatedRole.attachInlinePolicy(new iam.Policy(this, 'ConnectAPI_Resources', {
            statements: [new iam.PolicyStatement({
                    effect: iam.Effect.ALLOW,
                    actions: ["execute-api:Invoke"],
                    resources: [
                        `arn:aws:execute-api:${this.region}:${this.account}:${connectAPI.httpApiId}/$default/${ccpLogin_RouteCfn.routeKey.replace(/\s+/g, '')}`,
                        `arn:aws:execute-api:${this.region}:${this.account}:${connectAPI.httpApiId}/$default/${setConnectUserId_RouteCfn.routeKey.replace(/\s+/g, '')}`,
                        `arn:aws:execute-api:${this.region}:${this.account}:${connectAPI.httpApiId}/$default/${putConnectUserCache_RouteCfn.routeKey.replace(/\s+/g, '')}`,
                    ]
                })]
        }));
        this.connectAPI = connectAPI;
    }
}
exports.ConnectAPIStack = ConnectAPIStack;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29ubmVjdEFQSS1zdGFjay5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImNvbm5lY3RBUEktc3RhY2sudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLDBFQUEwRTtBQUMxRSxpQ0FBaUM7OztBQUVqQyxxQ0FBcUM7QUFDckMseURBQXlEO0FBQ3pELDhDQUE2QztBQUM3Qyx3Q0FBd0M7QUFDeEMsaURBQWdEO0FBQ2hELG9EQUFvRDtBQUNwRCxrRUFBa0U7QUFZbEUsTUFBYSxlQUFnQixTQUFRLEdBQUcsQ0FBQyxXQUFXO0lBSWhELFlBQVksS0FBb0IsRUFBRSxFQUFVLEVBQUUsS0FBMkI7O1FBQ3JFLEtBQUssQ0FBQyxLQUFLLEVBQUUsRUFBRSxFQUFFLEtBQUssQ0FBQyxDQUFDO1FBRXhCLE1BQU0sY0FBYyxHQUFHLElBQUksVUFBVSxDQUFDLGNBQWMsQ0FBQyxJQUFJLEVBQUUsZ0JBQWdCLEVBQUU7WUFDekUsWUFBWSxFQUFFLEdBQUcsS0FBSyxDQUFDLFVBQVUsaUJBQWlCO1lBQ2xELE9BQU8sRUFBRSxNQUFNLENBQUMsT0FBTyxDQUFDLFdBQVc7WUFDbkMsS0FBSyxFQUFFLHlDQUF5QztZQUNoRCxPQUFPLEVBQUUsR0FBRyxDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDO1lBQ2pDLFdBQVcsRUFBRTtnQkFDVCxpQkFBaUIsRUFBRSxLQUFLLENBQUMsU0FBUyxDQUFDLGtCQUFrQixDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7YUFDdEU7U0FDSixDQUFDLENBQUM7UUFFSCxpREFBaUQ7UUFDakQsTUFBQSxjQUFjLENBQUMsSUFBSSwwQ0FBRSxrQkFBa0IsQ0FBQyxJQUFJLEdBQUcsQ0FBQyxNQUFNLENBQUMsSUFBSSxFQUFFLGlDQUFpQyxFQUFFO1lBQzVGLFVBQVUsRUFBRTtnQkFDUixJQUFJLEdBQUcsQ0FBQyxlQUFlLENBQUM7b0JBQ3BCLE1BQU0sRUFBRSxHQUFHLENBQUMsTUFBTSxDQUFD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LFNBQVMsQ0FBQztRQUUzRCx5REFBeUQ7UUFDekQsS0FBSyxDQUFDLHdCQUF3QixDQUFDLGtCQUFrQixDQUFDLElBQUksR0FBRyxDQUFDLE1BQU0sQ0FBQyxJQUFJLEVBQUUsc0JBQXNCLEVBQUU7WUFDM0YsVUFBVSxFQUFFLENBQUMsSUFBSSxHQUFHLENBQUMsZUFBZSxDQUFDO29CQUNqQyxNQUFNLEVBQUUsR0FBRyxDQUFDLE1BQU0sQ0FBQyxLQUFLO29CQUN4QixPQUFPLEVBQUUsQ0FBQyxvQkFBb0IsQ0FBQztvQkFDL0IsU0FBUyxFQUFFO3dCQUNQLHVCQUF1QixJQUFJLENBQUMsTUFBTSxJQUFJLElBQUksQ0FBQyxPQUFPLElBQUksVUFBVSxDQUFDLFNBQVMsYUFBYSxpQkFBaUIsQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLE1BQU0sRUFBRSxFQUFFLENBQUMsRUFBRTt3QkFDdkksdUJBQXVCLElBQUksQ0FBQyxNQUFNLElBQUksSUFBSSxDQUFDLE9BQU8sSUFBSSxVQUFVLENBQUMsU0FBUyxhQUFhLHlCQUF5QixDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUMsTUFBTSxFQUFFLEVBQUUsQ0FBQyxFQUFFO3dCQUMvSSx1QkFBdUIsSUFBSSxDQUFDLE1BQU0sSUFBSSxJQUFJLENBQUMsT0FBTyxJQUFJLFVBQVUsQ0FBQyxTQUFTLGFBQWEsNEJBQTRCLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxNQUFNLEVBQUUsRUFBRSxDQUFDLEVBQUU7cUJBQ3JKO2lCQUNKLENBQUMsQ0FBQztTQUNOLENBQUMsQ0FBQyxDQUFDO1FBRUosSUFBSSxDQUFDLFVBQVUsR0FBRyxVQUFVLENBQUM7SUFFakMsQ0FBQztDQUNKO0FBcEtELDBDQW9LQyIsInNvdXJjZXNDb250ZW50IjpbIi8vIENvcHlyaWdodCAyMDIxIEFtYXpvbi5jb20sIEluYy4gb3IgaXRzIGFmZmlsaWF0ZXMuIEFsbCBSaWdodHMgUmVzZXJ2ZWQuXG4vLyBTUERYLUxpY2Vuc2UtSWRlbnRpZmllcjogTUlULTBcblxuaW1wb3J0ICogYXMgY2RrIGZyb20gJ0Bhd3MtY2RrL2NvcmUnO1xuaW1wb3J0ICogYXMgbm9kZUxhbWJkYSBmcm9tIFwiQGF3cy1jZGsvYXdzLWxhbWJkYS1ub2RlanNcIjtcbmltcG9ydCAqIGFzIGxhbWJkYSBmcm9tICdAYXdzLWNkay9hd3MtbGFtYmRhJ1xuaW1wb3J0ICogYXMgaWFtIGZyb20gJ0Bhd3MtY2RrL2F3cy1pYW0nO1xuaW1wb3J0ICogYXMgYXBpZ3cgZnJvbSAnQGF3cy1jZGsvYXdzLWFwaWdhdGV3YXknXG5pbXBvcnQgKiBhcyBhcGlndzIgZnJvbSBcIkBhd3MtY2RrL2F3cy1hcGlnYXRld2F5djJcIjtcbmltcG9ydCAqIGFzIGFwaWd3MmkgZnJvbSBcIkBhd3MtY2RrL2F3cy1hcGlnYXRld2F5djItaW50ZWdyYXRpb25zXCI7XG5pbXBvcnQgKiBhcyBkZGIgZnJvbSAnQGF3cy1jZGsvYXdzLWR5bmFtb2RiJztcblxuZXhwb3J0IGludGVyZmFjZSBDb25uZWN0QVBJU3RhY2tQcm9wcyBleHRlbmRzIGNkay5OZXN0ZWRTdGFja1Byb3BzIHtcbiAgICByZWFkb25seSBTU01QYXJhbXM6IGFueTtcbiAgICByZWFkb25seSBjb2duaXRvQXV0aGVudGljYXRlZFJvbGU6IGlhbS5JUm9sZTtcbiAgICByZWFkb25seSBjb2duaXRvVXNlclBvb2xJZDogc3RyaW5nO1xuICAgIHJlYWRvbmx5IGNvZ25pdG9Vc2VyUG9vbEFSTjogc3RyaW5nO1xuICAgIHJlYWRvbmx5IGFwcFRhYmxlOiBkZGIuSVRhYmxlO1xuICAgIHJlYWRvbmx5IGNka0FwcE5hbWU6IHN0cmluZztcbn1cblxuZXhwb3J0IGNsYXNzIENvbm5lY3RBUElTdGFjayBleHRlbmRzIGNkay5OZXN0ZWRTdGFjayB7XG5cbiAgICBwdWJsaWMgcmVhZG9ubHkgY29ubmVjdEFQSTogYXBpZ3cyLklIdHRwQXBpO1xuXG4gICAgY29uc3RydWN0b3Ioc2NvcGU6IGNkay5Db25zdHJ1Y3QsIGlkOiBzdHJpbmcsIHByb3BzOiBDb25uZWN0QVBJU3RhY2tQcm9wcykge1xuICAgICAgICBzdXBlcihzY29wZSwgaWQsIHByb3BzKTtcblxuICAgICAgICBjb25zdCBjY3BMb2dpbkxhbWJkYSA9IG5ldyBub2RlTGFtYmRhLk5vZGVqc0Z1bmN0aW9uKHRoaXMsICdDQ1BMb2dpbkxhbWJkYScsIHtcbiAgICAgICAgICAgIGZ1bmN0aW9uTmFtZTogYCR7cHJvcHMuY2RrQXBwTmFtZX0tQ0NQTG9naW5MYW1iZGFgLFxuICAgICAgICAgICAgcnVudGltZTogbGFtYmRhLlJ1bnRpbWUuTk9ERUpTXzEyX1gsXG4gICAgICAgICAgICBlbnRyeTogJ2xhbWJkYXMvaGFuZGxlcnMvQ29ubmVjdEFQSS9jY3BMb2dpbi5qcycsXG4gICAgICAgICAgICB0aW1lb3V0OiBjZGsuRHVyYXRpb24uc2Vjb25kcygyMCksXG4gICAgICAgICAgICBlbnZpcm9ubWVudDoge1xuICAgICAgICAgICAgICAgIENvbm5lY3RJbnN0YW5jZUlkOiBwcm9wcy5TU01QYXJhbXMuY29ubmVjdEluc3RhbmNlQVJOLnNwbGl0KCcvJylbMV0sXG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuXG4gICAgICAgIC8vQWxsb3cgY29ubmVjdEFQSUxhbWJkYSB0byBpbnZva2UgQW1hem9uIENvbm5lY3RcbiAgICAgICAgY2NwTG9naW5MYW1iZGEucm9sZT8uYXR0YWNoSW5saW5lUG9saWN5KG5ldyBpYW0uUG9saWN5KHRoaXMsICdDb25uZWN0R2V0RmVkZXJhdGlvblRva2VuQWNjZXNzJywge1xuICAgICAgICAgICAgc3RhdGVtZW50czogW1xuICAgICAgICAgICAgICAgIG5ldyBpYW0uUG9saWN5U3RhdGVtZW50KHtcbiAgICAgICAgICAgICAgICAgICAgZWZmZWN0OiBpYW0uRWZmZWN0LkFMTE9XLFxuICAgICAgICAgICAgICAgICAgICBhY3Rpb25zOiBbXCJjb25uZWN0OkdldEZlZGVyYXRpb25Ub2tlblwiXSxcbiAgICAgICAgICAgICAgICAgICAgcmVzb3VyY2VzOiBbcHJvcHMuU1NNUGFyYW1zLmNvbm5lY3RJbnN0YW5jZUFSTiArICcvdXNlci8qJ11cbiAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgXVxuICAgICAgICB9KSk7XG5cbiAgICAgICAgLy9BbGxvdyBjb25uZWN0QVBJTGFtYmRhIHRvIGludm9rZSBTVFNcbiAgICAgICAgY2NwTG9naW5MYW1iZGEucm9sZT8uYXR0YWNoSW5saW5lUG9saWN5KG5ldyBpYW0uUG9saWN5KHRoaXMsICdTVFNBc3N1bWVSb2xlQWNjZXNzJywge1xuICAgICAgICAgICAgc3RhdGVtZW50czogW1xuICAgICAgICAgICAgICAgIG5ldyBpYW0uUG9saWN5U3RhdGVtZW50KHtcbiAgICAgICAgICAgICAgICAgICAgZWZmZWN0OiBpYW0uRWZmZWN0LkFMTE9XLFxuICAgICAgICAgICAgICAgICAgICBhY3Rpb25zOiBbXCJzdHM6QXNzdW1lUm9sZVwiXSxcbiAgICAgICAgICAgICAgICAgICAgcmVzb3VyY2VzOiBbcHJvcHMuU1NNUGFyYW1zLmNjcExvZ2luTGFtYmRhUm9sZVRvQXNzdW1lID09PSBwcm9wcy5TU01QYXJhbXMuU1NNX05PVF9ERUZJTkVEID8gY2NwTG9naW5MYW1iZGEucm9sZS5yb2xlQXJuIDogcHJvcHMuU1NNUGFyYW1zLmNjcExvZ2luTGFtYmRhUm9sZVRvQXNzdW1lXVxuICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICBdXG4gICAgICAgIH0pKTtcblxuICAgICAgICAvL2FkZCBlbnYgdmFyaWFibGUgLSBSb2xlVG9Bc3N1bWVcbiAgICAgICAgY2NwTG9naW5MYW1iZGEuYWRkRW52aXJvbm1lbnQoJ1JvbGVUb0Fzc3VtZScsIHByb3BzLlNTTVBhcmFtcy5jY3BMb2dpbkxhbWJkYVJvbGVUb0Fzc3VtZSA9PT0gcHJvcHMuU1NNUGFyYW1zLlNTTV9OT1RfREVGSU5FRCA/IGNjcExvZ2luTGFtYmRhLnJvbGU/LnJvbGVBcm4gfHwgJycgOiBwcm9wcy5TU01QYXJhbXMuY2NwTG9naW5MYW1iZGFSb2xlVG9Bc3N1bWUpO1xuXG4gICAgICAgIGNvbnN0IHB1dENvbm5lY3RVc2VyQ2FjaGVMYW1iZGEgPSBuZXcgbm9kZUxhbWJkYS5Ob2RlanNGdW5jdGlvbih0aGlzLCAnUHV0Q29ubmVjdFVzZXJDYWNoZUxhbWJkYScsIHtcbiAgICAgICAgICAgIGZ1bmN0aW9uTmFtZTogYCR7cHJvcHMuY2RrQXBwTmFtZX0tUHV0Q29ubmVjdFVzZXJDYWNoZUxhbWJkYWAsXG4gICAgICAgICAgICBydW50aW1lOiBsYW1iZGEuUnVudGltZS5OT0RFSlNfMTJfWCxcbiAgICAgICAgICAgIGVudHJ5OiAnbGFtYmRhcy9oYW5kbGVycy9Db25uZWN0QVBJL3B1dENvbm5lY3RVc2VyQ2FjaGUuanMnLFxuICAgICAgICAgICAgdGltZW91dDogY2RrLkR1cmF0aW9uLnNlY29uZHMoMjApLFxuICAgICAgICAgICAgZW52aXJvbm1lbnQ6IHtcbiAgICAgICAgICAgICAgICBDb25uZWN0SW5zdGFuY2VJZDogcHJvcHMuU1NNUGFyYW1zLmNvbm5lY3RJbnN0YW5jZUFSTi5zcGxpdCgnLycpWzFdLFxuICAgICAgICAgICAgICAgIEREQl9UQUJMRTogcHJvcHMuYXBwVGFibGUudGFibGVOYW1lXG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgICBwcm9wcy5hcHBUYWJsZS5ncmFudFJlYWRXcml0ZURhdGEocHV0Q29ubmVjdFVzZXJDYWNoZUxhbWJkYSk7XG5cbiAgICAgICAgcHV0Q29ubmVjdFVzZXJDYWNoZUxhbWJkYS5yb2xlPy5hdHRhY2hJbmxpbmVQb2xpY3kobmV3IGlhbS5Qb2xpY3kodGhpcywgJ0Nvbm5lY3REZXNjcmliZVVzZXJBY2Nlc3MnLCB7XG4gICAgICAgICAgICBzdGF0ZW1lbnRzOiBbXG4gICAgICAgICAgICAgICAgbmV3IGlhbS5Qb2xpY3lTdGF0ZW1lbnQoe1xuICAgICAgICAgICAgICAgICAgICBlZmZlY3Q6IGlhbS5FZmZlY3QuQUxMT1csXG4gICAgICAgICAgICAgICAgICAgIGFjdGlvbnM6IFtcImNvbm5lY3Q6RGVzY3JpYmVVc2VyXCJdLFxuICAgICAgICAgICAgICAgICAgICByZXNvdXJjZXM6IFtcbiAgICAgICAgICAgICAgICAgICAgICAgIHByb3BzLlNTTVBhcmFtcy5jb25uZWN0SW5zdGFuY2VBUk4gKyAnL3VzZXIvKicsXG4gICAgICAgICAgICAgICAgICAgICAgICBwcm9wcy5TU01QYXJhbXMuY29ubmVjdEluc3RhbmNlQVJOICsgJy9hZ2VudC8qJ1xuICAgICAgICAgICAgICAgICAgICBdXG4gICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIF1cbiAgICAgICAgfSkpO1xuXG4gICAgICAgIHB1dENvbm5lY3RVc2VyQ2FjaGVMYW1iZGEucm9sZT8uYXR0YWNoSW5saW5lUG9saWN5KG5ldyBpYW0uUG9saWN5KHRoaXMsICdDb25uZWN0RGVzY3JpYmVVc2VySGllcmFyY2h5R3JvdXBBY2Nlc3MnLCB7XG4gICAgICAgICAgICBzdGF0ZW1lbnRzOiBbXG4gICAgICAgICAgICAgICAgbmV3IGlhbS5Qb2xpY3lTdGF0ZW1lbnQoe1xuICAgICAgICAgICAgICAgICAgICBlZmZlY3Q6IGlhbS5FZmZlY3QuQUxMT1csXG4gICAgICAgICAgICAgICAgICAgIGFjdGlvbnM6IFtcImNvbm5lY3Q6RGVzY3JpYmVVc2VySGllcmFyY2h5R3JvdXBcIl0sXG4gICAgICAgICAgICAgICAgICAgIHJlc291cmNlczogW3Byb3BzLlNTTVBhcmFtcy5jb25uZWN0SW5zdGFuY2VBUk4gKyAnL2FnZW50LWdyb3VwLyonXVxuICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICBdXG4gICAgICAgIH0pKTtcblxuXG4gICAgICAgIGNvbnN0IHNldENvbm5lY3RVc2VySWRMYW1iZGEgPSBuZXcgbm9kZUxhbWJkYS5Ob2RlanNGdW5jdGlvbih0aGlzLCAnU2V0Q29ubmVjdFVzZXJJZExhbWJkYScsIHtcbiAgICAgICAgICAgIGZ1bmN0aW9uTmFtZTogYCR7cHJvcHMuY2RrQXBwTmFtZX0tU2V0Q29ubmVjdFVzZXJJZExhbWJkYWAsXG4gICAgICAgICAgICBydW50aW1lOiBsYW1iZGEuUnVudGltZS5OT0RFSlNfMTJfWCxcbiAgICAgICAgICAgIGVudHJ5OiAnbGFtYmRhcy9oYW5kbGVycy9Db25uZWN0QVBJL3NldENvbm5lY3RVc2VySWQuanMnLFxuICAgICAgICAgICAgdGltZW91dDogY2RrLkR1cmF0aW9uLnNlY29uZHMoMjApLFxuICAgICAgICAgICAgZW52aXJvbm1lbnQ6IHtcbiAgICAgICAgICAgICAgICBDb25uZWN0SW5zdGFuY2VJZDogcHJvcHMuU1NNUGFyYW1zLmNvbm5lY3RJbnN0YW5jZUFSTi5zcGxpdCgnLycpWzFdLFxuICAgICAgICAgICAgICAgIENvZ25pdG9Vc2VyUG9vbElkOiBwcm9wcy5jb2duaXRvVXNlclBvb2xJZCxcbiAgICAgICAgICAgICAgICBEREJfVEFCTEU6IHByb3BzLmFwcFRhYmxlLnRhYmxlTmFtZVxuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcblxuICAgICAgICBzZXRDb25uZWN0VXNlcklkTGFtYmRhLnJvbGU/LmF0dGFjaElubGluZVBvbGljeShuZXcgaWFtLlBvbGljeSh0aGlzLCAnQ29ubmVjdERlc2NyaWJlVXNlckFjY2VzczInLCB7XG4gICAgICAgICAgICBzdGF0ZW1lbnRzOiBbXG4gICAgICAgICAgICAgICAgbmV3IGlhbS5Qb2xpY3lTdGF0ZW1lbnQoe1xuICAgICAgICAgICAgICAgICAgICBlZmZlY3Q6IGlhbS5FZmZlY3QuQUxMT1csXG4gICAgICAgICAgICAgICAgICAgIGFjdGlvbnM6IFtcImNvbm5lY3Q6RGVzY3JpYmVVc2VyXCJdLFxuICAgICAgICAgICAgICAgICAgICByZXNvdXJjZXM6IFtcbiAgICAgICAgICAgICAgICAgICAgICAgIHByb3BzLlNTTVBhcmFtcy5jb25uZWN0SW5zdGFuY2VBUk4gKyAnL3VzZXIvKicsXG4gICAgICAgICAgICAgICAgICAgICAgICBwcm9wcy5TU01QYXJhbXMuY29ubmVjdEluc3RhbmNlQVJOICsgJy9hZ2VudC8qJ1xuICAgICAgICAgICAgICAgICAgICBdXG4gICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIF1cbiAgICAgICAgfSkpO1xuXG4gICAgICAgIHNldENvbm5lY3RVc2VySWRMYW1iZGEucm9sZT8uYXR0YWNoSW5saW5lUG9saWN5KG5ldyBpYW0uUG9saWN5KHRoaXMsICdDb2duaXRvVXBkYXRlVXNlckF0dHJpYnV0ZXNBY2Nlc3MnLCB7XG4gICAgICAgICAgICBzdGF0ZW1lbnRzOiBbXG4gICAgICAgICAgICAgICAgbmV3IGlhbS5Qb2xpY3lTdGF0ZW1lbnQoe1xuICAgICAgICAgICAgICAgICAgICBlZmZlY3Q6IGlhbS5FZmZlY3QuQUxMT1csXG4gICAgICAgICAgICAgICAgICAgIGFjdGlvbnM6IFtcImNvZ25pdG8taWRwOkFkbWluVXBkYXRlVXNlckF0dHJpYnV0ZXNcIl0sXG4gICAgICAgICAgICAgICAgICAgIHJlc291cmNlczogW3Byb3BzLmNvZ25pdG9Vc2VyUG9vbEFSTl1cbiAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgXVxuICAgICAgICB9KSk7XG5cblxuICAgICAgICAvL2NyZWF0ZSBDb25uZWN0QVBJIEludGVncmF0aW9uXG4gICAgICAgIGNvbnN0IGNvbm5lY3RBUEkgPSBuZXcgYXBpZ3cyLkh0dHBBcGkodGhpcywgJ0Nvbm5lY3RBUEknLCB7XG4gICAgICAgICAgICBhcGlOYW1lOiBgJHtwcm9wcy5jZGtBcHBOYW1lfS1Db25uZWN0QVBJYCxcbiAgICAgICAgICAgIGNvcnNQcmVmbGlnaHQ6IHtcbiAgICAgICAgICAgICAgICBhbGxvd09yaWdpbnM6IHByb3BzLlNTTVBhcmFtcy5hZ2VudEFQSUFsbG93ZWRPcmlnaW5zLnNwbGl0KCcsJykubWFwKChpdGVtOiBzdHJpbmcpID0+IGl0ZW0udHJpbSgpKSxcbiAgICAgICAgICAgICAgICBhbGxvd01ldGhvZHM6IFthcGlndzIuQ29yc0h0dHBNZXRob2QuUE9TVCwgYXBpZ3cyLkNvcnNIdHRwTWV0aG9kLlBVVF0sXG4gICAgICAgICAgICAgICAgYWxsb3dIZWFkZXJzOiBhcGlndy5Db3JzLkRFRkFVTFRfSEVBREVSUy5jb25jYXQoWydjb2duaXRvSWRUb2tlbiddKVxuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcblxuICAgICAgICBjb25zdCBjY3BMb2dpbl9Sb3V0ZSA9IG5ldyBhcGlndzIuSHR0cFJvdXRlKHRoaXMsICdDQ1BMb2dpbl9Sb3V0ZScsIHtcbiAgICAgICAgICAgIGh0dHBBcGk6IGNvbm5lY3RBUEksXG4gICAgICAgICAgICBpbnRlZ3JhdGlvbjogbmV3IGFwaWd3MmkuTGFtYmRhUHJveHlJbnRlZ3JhdGlvbih7IGhhbmRsZXI6IGNjcExvZ2luTGFtYmRhIH0pLFxuICAgICAgICAgICAgcm91dGVLZXk6IGFwaWd3Mi5IdHRwUm91dGVLZXkud2l0aCgnL2NjcGxvZ2luJywgYXBpZ3cyLkh0dHBNZXRob2QuUE9TVClcbiAgICAgICAgfSk7XG4gICAgICAgIGNvbnN0IGNjcExvZ2luX1JvdXRlQ2ZuID0gY2NwTG9naW5fUm91dGUubm9kZS5kZWZhdWx0Q2hpbGQgYXMgYXBpZ3cyLkNmblJvdXRlO1xuICAgICAgICBjY3BMb2dpbl9Sb3V0ZUNmbi5hdXRob3JpemF0aW9uVHlwZSA9ICdBV1NfSUFNJztcblxuICAgICAgICBjb25zdCBzZXRDb25uZWN0VXNlcklkX1JvdXRlID0gbmV3IGFwaWd3Mi5IdHRwUm91dGUodGhpcywgJ1NldENvbm5lY3RVc2VySWRfUm91dGUnLCB7XG4gICAgICAgICAgICBodHRwQXBpOiBjb25uZWN0QVBJLFxuICAgICAgICAgICAgaW50ZWdyYXRpb246IG5ldyBhcGlndzJpLkxhbWJkYVByb3h5SW50ZWdyYXRpb24oeyBoYW5kbGVyOiBzZXRDb25uZWN0VXNlcklkTGFtYmRhIH0pLFxuICAgICAgICAgICAgcm91dGVLZXk6IGFwaWd3Mi5IdHRwUm91dGVLZXkud2l0aCgnL3NldENvbm5lY3RVc2VySWQnLCBhcGlndzIuSHR0cE1ldGhvZC5QT1NUKVxuICAgICAgICB9KTtcbiAgICAgICAgY29uc3Qgc2V0Q29ubmVjdFVzZXJJZF9Sb3V0ZUNmbiA9IHNldENvbm5lY3RVc2VySWRfUm91dGUubm9kZS5kZWZhdWx0Q2hpbGQgYXMgYXBpZ3cyLkNmblJvdXRlO1xuICAgICAgICBzZXRDb25uZWN0VXNlcklkX1JvdXRlQ2ZuLmF1dGhvcml6YXRpb25UeXBlID0gJ0FXU19JQU0nO1xuXG4gICAgICAgIGNvbnN0IHB1dENvbm5lY3RVc2VyQ2FjaGVfUm91dGUgPSBuZXcgYXBpZ3cyLkh0dHBSb3V0ZSh0aGlzLCAnUHV0Q29ubmVjdFVzZXJDYWNoZV9Sb3V0ZScsIHtcbiAgICAgICAgICAgIGh0dHBBcGk6IGNvbm5lY3RBUEksXG4gICAgICAgICAgICBpbnRlZ3JhdGlvbjogbmV3IGFwaWd3MmkuTGFtYmRhUHJveHlJbnRlZ3JhdGlvbih7IGhhbmRsZXI6IHB1dENvbm5lY3RVc2VyQ2FjaGVMYW1iZGEgfSksXG4gICAgICAgICAgICByb3V0ZUtleTogYXBpZ3cyLkh0dHBSb3V0ZUtleS53aXRoKCcvY29ubmVjdC11c2VyLWNhY2hlJywgYXBpZ3cyLkh0dHBNZXRob2QuUFVUKVxuICAgICAgICB9KVxuICAgICAgICBjb25zdCBwdXRDb25uZWN0VXNlckNhY2hlX1JvdXRlQ2ZuID0gcHV0Q29ubmVjdFVzZXJDYWNoZV9Sb3V0ZS5ub2RlLmRlZmF1bHRDaGlsZCBhcyBhcGlndzIuQ2ZuUm91dGU7XG4gICAgICAgIHB1dENvbm5lY3RVc2VyQ2FjaGVfUm91dGVDZm4uYXV0aG9yaXphdGlvblR5cGUgPSAnQVdTX0lBTSc7XG5cbiAgICAgICAgLy9BbGxvdyBJZGVudGl0eSBQb29sIHRvIGludm9rZSBDb25uZWN0QVBJIExvZ2luIHJlc291cmNlXG4gICAgICAgIHByb3BzLmNvZ25pdG9BdXRoZW50aWNhdGVkUm9sZS5hdHRhY2hJbmxpbmVQb2xpY3kobmV3IGlhbS5Qb2xpY3kodGhpcywgJ0Nvbm5lY3RBUElfUmVzb3VyY2VzJywge1xuICAgICAgICAgICAgc3RhdGVtZW50czogW25ldyBpYW0uUG9saWN5U3RhdGVtZW50KHtcbiAgICAgICAgICAgICAgICBlZmZlY3Q6IGlhbS5FZmZlY3QuQUxMT1csXG4gICAgICAgICAgICAgICAgYWN0aW9uczogW1wiZXhlY3V0ZS1hcGk6SW52b2tlXCJdLFxuICAgICAgICAgICAgICAgIHJlc291cmNlczogW1xuICAgICAgICAgICAgICAgICAgICBgYXJuOmF3czpleGVjdXRlLWFwaToke3RoaXMucmVnaW9ufToke3RoaXMuYWNjb3VudH06JHtjb25uZWN0QVBJLmh0dHBBcGlJZH0vJGRlZmF1bHQvJHtjY3BMb2dpbl9Sb3V0ZUNmbi5yb3V0ZUtleS5yZXBsYWNlKC9cXHMrL2csICcnKX1gLFxuICAgICAgICAgICAgICAgICAgICBgYXJuOmF3czpleGVjdXRlLWFwaToke3RoaXMucmVnaW9ufToke3RoaXMuYWNjb3VudH06JHtjb25uZWN0QVBJLmh0dHBBcGlJZH0vJGRlZmF1bHQvJHtzZXRDb25uZWN0VXNlcklkX1JvdXRlQ2ZuLnJvdXRlS2V5LnJlcGxhY2UoL1xccysvZywgJycpfWAsXG4gICAgICAgICAgICAgICAgICAgIGBhcm46YXdzOmV4ZWN1dGUtYXBpOiR7dGhpcy5yZWdpb259OiR7dGhpcy5hY2NvdW50fToke2Nvbm5lY3RBUEkuaHR0cEFwaUlkfS8kZGVmYXVsdC8ke3B1dENvbm5lY3RVc2VyQ2FjaGVfUm91dGVDZm4ucm91dGVLZXkucmVwbGFjZSgvXFxzKy9nLCAnJyl9YCxcbiAgICAgICAgICAgICAgICBdXG4gICAgICAgICAgICB9KV1cbiAgICAgICAgfSkpO1xuXG4gICAgICAgIHRoaXMuY29ubmVjdEFQSSA9IGNvbm5lY3RBUEk7XG5cbiAgICB9XG59XG4iXX0=